name: "Update hyprpm pin on latest Hyprland release"
on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *" # daily at midnight
jobs:
  pin-latest-hyprland:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history so we can tag any commit
      - uses: cachix/install-nix-action@v30
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          extra_nix_config: |
            extra-substituters = https://hyprland.cachix.org
            extra-trusted-public-keys = hyprland.cachix.org-1:a7pgxzMz7+chwVL3/pzj6jIBMioiJM7ypFP8PwtkuGc=
      - name: Update pins
        id: update_pins
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -eu
          set -m   # workaround: I get "fg: no job control" even though I don't use any job control
          git fetch --depth=1 --tags origin main

          # Run pin-latest-hyprland and capture output
          PIN_OUTPUT=$(./scripts/ci/pin-latest-hyprland origin/main)
          
          # Parse output: "hyprland_tag hyprgrass_commit"
          if [ -n "$PIN_OUTPUT" ]; then
            # Validate output format (should have 2 space-separated values)
            WORD_COUNT=$(echo "$PIN_OUTPUT" | wc -w)
            if [ "$WORD_COUNT" -eq 2 ]; then
              HL_TAG=$(echo "$PIN_OUTPUT" | cut -d' ' -f1)
              HYPRGRASS_COMMIT=$(echo "$PIN_OUTPUT" | cut -d' ' -f2)
              echo "hl_tag=$HL_TAG" >> $GITHUB_OUTPUT
              echo "hyprgrass_commit=$HYPRGRASS_COMMIT" >> $GITHUB_OUTPUT
            else
              echo "Warning: Unexpected output format from pin-latest-hyprland: '$PIN_OUTPUT'"
            fi
          fi

      - name: Tag pinned commit
        if: steps.update_pins.outputs.hl_tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -eu
          
          HL_TAG="${{ steps.update_pins.outputs.hl_tag }}"
          HYPRGRASS_COMMIT="${{ steps.update_pins.outputs.hyprgrass_commit }}"
          
          # Strip 'v' prefix from version if present for consistent tag naming
          VERSION="${HL_TAG#v}"
          TAG_NAME="hl-${VERSION}"
          echo "Tagging hyprgrass commit $HYPRGRASS_COMMIT with $TAG_NAME"
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Tag the specific hyprgrass commit (if tag doesn't exist)
          if [ -n "$(git tag -l "$TAG_NAME")" ]; then
            echo "Tag $TAG_NAME already exists, skipping"
          else
            git tag "$TAG_NAME" "$HYPRGRASS_COMMIT"
            git push origin "$TAG_NAME"
            echo "Successfully created and pushed tag $TAG_NAME"
          fi

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: 'ci: automated update of hyprpm.toml'
          title: 'Automated PR: Update hyprpm pin'
          body: 'This PR was created by a Github Actions workflow'

